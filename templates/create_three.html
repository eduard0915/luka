{% extends 'body.html' %}
{% load static %}


{% block head %}

    {% block head_list %}

    {% endblock %}

{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-{{ div }}">
            <div class="tile">
                <h3 class="tile-title">{{ subtitle }}</h3>
                <div class="tile-body">
                    <form id="mainForm" enctype="multipart/form-data" method="post" action="" class="form-horizontal">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{{ action }}">
                        <div class="row">
                            {% for field in form.visible_fields %}
                                <div class="{% if field.name == 'reagent' %}col-md-5
                                {% elif field.name == 'code_solution' or field.name == 'code_solution_std' or field.name == 'concentration' or field.name == 'concentration_std' or field.name == 'concentration_unit' %}col-md-2
                                {% elif field.name == 'solute_reagent' or field.name == 'solute_std' or field.name == 'solvent_reagent' %}col-md-6
                                {% else %}col-md-3{% endif %}">
                                    <div class="form-group mb-2">
                                        {% if field.name == 'groups' or field.name == 'is_active' or field.name == 'site' or field.name == 'reagent' or field.name == 'reagent_liquid' %}
                                            <label class="control-label">
                                                {{ field.label }}{% if field.field.required %}*{% endif %}
                                            </label>
                                            {{ field }}
                                        {% else %}
                                            {% if field.field.widget.input_type == 'file' %}
                                                <label class="control-label">
                                                    {{ field.label }}{% if field.field.required %}*{% endif %}
                                                </label>
                                                {{ field }}
                                                {% if field.help_text %}
                                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            {% else %}
                                                <label class="control-label">
                                                    {{ field.label }}{% if field.field.required %}*{% endif %}
                                                </label>
                                                {{ field }}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="tile-footer">
                            <button type="submit" class="btn btn-primary me-2" id="btnSubmit">
                                <i class="fa fa-fw fa-lg fa-check-circle me-2"></i>Guardar
                            </button>
                            {% if list_url %}
                                <a href="{{ list_url }}" class="btn btn-secondary">
                                    <i class="fa fa-fw fa-lg fa-times-circle me-2"></i>Cancelar
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts_detail %}

    {% if  entity == 'Preparar Solución Estándar' %}
        <script src="{% static 'form_solution_std.js' %}"></script>
    {% endif %}

    <script type="application/javascript">

        const dateInputs = document.querySelectorAll('[data-datepicker="1"], .js-datepicker');
        if (dateInputs.length) {
            dateInputs.forEach(function (input) {
                if (!input || input.dataset.datepickerInitialized) return;

                // Ensure BS5 form-control styling
                input.classList.add('form-control');

                // Wrap in input-group with calendar button (only once)
                if (!input.dataset.datepickerEnhanced) {
                    const group = document.createElement('div');
                    group.className = 'input-group';
                    const parent = input.parentNode;
                    parent.insertBefore(group, input);
                    group.appendChild(input);

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary';
                    btn.setAttribute('aria-label', 'Abrir calendario');
                    btn.innerHTML = '<i class="bi bi-calendar-date"></i>';
                    const span = document.createElement('span');
                    span.className = 'input-group-text p-0';
                    // Use a button after to match BS5 demo aesthetics
                    group.appendChild(btn);
                    input.dataset.datepickerEnhanced = '1';

                    // Initialize Datepicker with BS5-friendly options
                    const dp = new Datepicker(input, {
                        autohide: true,
                        language: 'es',
                        {#format: 'yyyy-mm-dd',#}
                        todayHighlight: true,
                        clearBtn: true,
                        // ensure the picker attaches within the modal to handle z-index correctly
                        container: input.closest('.modal') || document.body,
                        // Use Bootstrap icons for navigation arrows
                        prevArrow: '<i class="bi bi-chevron-left"></i>',
                        nextArrow: '<i class="bi bi-chevron-right"></i>',
                        buttonClass: 'btn btn-outline-secondary'
                    });

                    // Toggle/show the datepicker on button click
                    btn.addEventListener('click', function () {
                        dp.show();
                    });
                } else {
                    // If already enhanced, just init the picker
                    new Datepicker(input, {
                        autohide: true,
                        language: 'es',
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        clearBtn: true,
                        container: input.closest('.modal') || document.body,
                        prevArrow: '<i class="bi bi-chevron-left"></i>',
                        nextArrow: '<i class="bi bi-chevron-right"></i>',
                        buttonClass: 'btn btn-outline-secondary'
                    });
                }
                input.dataset.datepickerInitialized = '1';
            });
        }

        document.getElementById('mainForm').addEventListener('submit', function (e) {
            e.preventDefault();

            // Deshabilitar el botón y mostrar spinner
            const btnSubmit = document.getElementById('btnSubmit');
            const originalBtnContent = btnSubmit.innerHTML;
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

            const parameters = new FormData(this);

            axios.post(window.location.pathname, parameters, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
                .then(function (response) {
                    console.log('Response:', response.data);

                    // ✅ Caso 1: Éxito - Redirigir al detalle
                    if (response.data.success && response.data.redirect_url) {
                        window.location.href = response.data.redirect_url;
                        return;
                    }

                    // ❌ Caso 2: Error - Redirigir a la lista inmediatamente
                    if (response.data.error) {
                        console.error('Validation error:', response.data.error);
                        window.location.href = '{{ list_url }}';
                        return;
                    }

                    // ⚠️ Caso 3: Respuesta inesperada - redirigir a lista
                    console.error('Respuesta inesperada del servidor');
                    window.location.href = '{{ list_url }}';
                })
                .catch(function (error) {
                    console.error('Error:', error);

                    // Mostrar error en consola
                    let errorMsg = 'Error al procesar la solicitud';
                    if (error.response && error.response.data && error.response.data.error) {
                        errorMsg = error.response.data.error;
                    } else if (error.response) {
                        errorMsg = `Error ${error.response.status}: ${error.response.statusText}`;
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    console.error('Error:', errorMsg);
                    window.location.href = '{{ list_url }}';
                });
        });

    </script>

{% endblock %}