{% extends 'body.html' %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}
{% load l10n %}


{% block head %}
    {% block head_list %}
        <style>
            /* Ajustes para la tabla con id data_0 */
            #data_0, #data_0 th, #data_0 td {
                font-size: 0.85rem;
            }

            #data_0 thead th {
                text-align: center;
                vertical-align: middle;
            }
        </style>
    {% endblock %}
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-11">
            <div class="tile mb-3">
                <div class="tile-title">
                    <h3 class="title">
                        Solución {{ object.solute_reagent.reagent.description_reagent }} {{ object.concentration | unlocalize }}
                        {{ object.concentration_unit }} <span class="badge bg-primary ms-3">{{ object.code_solution }}</span>
                    </h3>
                </div>
                <div class="tile-body">
                    <div class="row">
                        <div class="col-md-2">
                            <b>Cantidad a Preparar </b><br>
                            <p>{{ object.quantity_solution | intcomma:False }} mL</p>
                        </div>
                        <div class="col-md-2">
                            <b>Concentración</b><br>
                            <p>{{ object.concentration | unlocalize }} {{ object.concentration_unit }}</p>
                        </div>
                        <div class="col-md-4">
                            <b>Reactivo </b><br>
                            <p><b class="text-danger">{{ object.quantity_reagent | unlocalize }} {{ object.solute_reagent.reagent.umb }}</b>
                                de {{ object.solute_reagent.reagent.description_reagent }} al
                                {{ object.solute_reagent.purity }}{{ object.solute_reagent.reagent.purity_unit }}, Lote
                                N°: {{ object.solute_reagent.batch_number }}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <b>Solvente</b><br>
                            <p>
                                {% if object.quantity_solvent %}
                                    {{ object.quantity_solvent | unlocalize }} {{ object.solvent_reagent.reagent.umb }} de
                                {% endif %}
                                {{ object.solvent_reagent.reagent.description_reagent }}
                                {% if not object.solvent_reagent.purity == 100 %}
                                    {{ object.solvent_reagent.purity }}{{ object.solvent_reagent.reagent.purity_unit }},
                                {% endif %}
                                Lote N°: {{ object.solvent_reagent.batch_number }}
                            </p>
                        </div>
                    </div>
                    {% if object.quantity_solvent %}
                        <div class="row mt-1">
                            <div class="col-md-4">
                                <b>Preparado por </b><br>
                                <p>{{ object.preparated_by }}</p>
                            </div>
                            <div class="col-md-3">
                                <b>Fecha de Preparación</b><br>
                                <p>{{ object.preparation_date | date:'Y-m-d' }}</p>
                            </div>
                            <div class="col-md-3">
                                <b>Vencimiento</b><br>
                                <p>{{ object.expire_date_solution | date:'Y-m-d' }}</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="tile-footer">
                    {% if not object.quantity_solvent %}
                        {% if object.quantity_reagent < object.solute_reagent.quantity_stock %}
                            <button onclick="open_modal('{% url 'solution:add_solvent_solution' object.id %}')"
                                    class="btn btn-primary me-2">
                                <i class="bi bi-moisture me-2"></i> Añadir de Solvente
                            </button>
                        {% else %}
                                <p class="text-danger p-2">Cantidad de Reactivo requerida mayor que la
                                    disponible {{ object.solute_reagent.quantity_stock | unlocalize }} {{ object.solute_reagent.reagent.umb }}</p>
                        {% endif %}
                        <a href="{{ update_solution }}" type="button" class="btn btn-warning me-2">
                            <i class="fa fa-fw fa-lg fa-pencil me-2"></i> Editar
                        </a>
                    {% endif %}
                    {% if object.coefficient_variation < 2 %}
                        <a href="{{ label_url }}" type="button" class="btn btn-danger me-2" target="_blank">
                            <i class="fa fa-fw fa-lg fa-ticket me-2"></i> Etiqueta
                        </a>
                    {% endif %}
                    {% if list_url %}
                        <a href="{{ list_url }}" class="btn btn-secondary me-2">
                            <i class="fa fa-fw fa-lg fa-list me-2"></i>Soluciones
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% if object.standardizable and object.quantity_solvent %}
        <div class="row">
            <div class="col-md-11">
                <div class="tile mb-3">
                    <div class="tile-title">
                        <h3 class="title">
                            Estandarización de la Solución
                        </h3>
                    </div>
                    <div class="tile-body">
                        <div class="row">
                            <div class="col-md-3">
                                <b>Volumen de Alícuota</b><br>
                                <p class="text-primary"><b>{{ std.quantity_aliquot | unlocalize }} mL</b></p>
                            </div>
                            <div class="col-md-3">
                                <b>Concentración Real</b><br>
                                {% if object.average_concentration %}
                                    <p class="text-success"><b>{{ object.average_concentration | unlocalize }}
                                        {{ object.concentration_unit }}</b></p>
                                {% else %}
                                    <p class="text-danger"><b>Pendiente</b></p>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <b>Coeficiente de Variación</b><br>
                                {% if object.coefficient_variation %}
                                    <p class="text-success"><b>{{ object.coefficient_variation | unlocalize }}%</b></p>
                                {% else %}
                                    <p class="text-danger"><b>Pendiente</b></p>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                {% if standard_count > 2 %}
                                    {% if object.coefficient_variation > 2 %}
                                        <div class="bs-component">
                                            <div class="alert alert-dismissible alert-danger d-flex align-items-center pe-3 mb-2">
                                                <i class="bi bi-x-octagon fa-2x me-2"></i>
                                                <strong class="me-2">No Cumple.</strong> CV Mayor del 2%.
                                            </div>
                                            <b class="text-danger"> Realice una Estandarización Adicional</b>
                                        </div>
                                    {% else %}
                                        {% if object.average_concentration %}
                                            <div class="bs-component">
                                                <div class="alert alert-dismissible alert-success d-flex align-items-center">
                                                    <i class="fas fa-check-circle fa-2x me-2"></i>
                                                    <strong>Cumple!</strong>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% elif standard_count > 0 and standard_count < 3 %}
                                    <div class="bs-component">
                                        <div class="alert alert-dismissible alert-warning d-flex align-items-center pe-3 mb-2">
                                            <i class="bi bi-x-octagon fa-2x me-2"></i>
                                            <strong class="me-2">Mínimo 3 replicas</strong>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if object.standardized_by %}
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <b>Estandarizado por</b><br>
                                    <p>{{ object.standardized_by }}</p>
                                </div>
                                <div class="col-md-4">
                                    <b>Fecha de Estandarización</b><br>
                                    <p>{{ object.standarization_date | date:'Y-m-d' }}</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if standard_count <= 4 %}
                        <div class="tile-footer">
                            <a onclick="open_modal('{{ add_standardization }}')" type="button" class="btn btn-primary me-2">
                                <i class="fa fa-plus"></i> Registrar
                            </a>
                        </div>
                   {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    {% if standardizations %}
        <!-- Historial de estandarizaciones de la misma solución -->
        <div class="row">
            <div class="col-md-11">
                <div class="tile mb-3">
                    <div class="tile-title">
                        <h3 class="title">Estandarizaciones</h3>
                    </div>
                    <div class="tile-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="data_0">
                                <thead>
                                <tr>
                                    <th style="width:10%">Fecha</th>
                                    <th style="width:45%">Solución Estándar</th>
                                    <th style="width:10%">mL Estándar </th>
                                    <th style="width:10%">[ ]</th>
                                    <th style="width:20%">Realizado por</th>
                                    <th style="width:5%">Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for std in standardizations %}
                                    <tr>
                                        <td class="text-center">{{ std.standarization_date | date:'Y-m-d' }}</td>
                                        <td class="text-center">{{ std.standard_sln }}</td>
                                        <td class="text-center">{{ std.quantity_standard | unlocalize }}</td>
                                        <td class="text-center">
                                            <b>{{ std.concentration_sln | unlocalize }} {{ std.solution.concentration_unit }}</b>
                                        </td>
                                        <td>{{ std.standardized_by }}</td>
                                        <td class="text-center">
                                            <a onclick="open_modal('{% url 'solution:delete_standardization_solution' std.id %}')"
                                               title="Eliminar">
                                                <i class="bi bi-trash text-danger me-2"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            No hay otras estandarizaciones registradas.
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if transactions %}
        <div class="row">
            <div class="col-md-11">
                <div class="tile mb-3">
                    <div class="tile-title">
                        <h3 class="title">Detalle Consumo</h3>
                    </div>
                    <div class="tile-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="data_1">
                                <thead>
                                <tr>
                                    <th style="width:12%">Fecha</th>
                                    <th style="width:15%">Tipo</th>
                                    <th style="width:10%">Cant. ({{ object.solute_reagent.reagent.umb }})</th>
                                    <th style="width:25%">Realizada por</th>
                                    <th style="width:30%">Detalle</th>
                                    <th style="width:8%">Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for foo in transactions %}
                                    <tr>
                                        <td>{{ foo.date_transaction | date:'Y-m-d' }}</td>
                                        <td>{{ foo.type_transaction }}</td>
                                        <td>{{ foo.quantity | intcomma:False }}</td>
                                        <td>{{ foo.user_transaction }}</td>
                                        <td>{{ foo.detail_transaction }}</td>
                                        <td>
                                            <a onclick="open_modal('{% url 'user:update_training' foo.id %}')"
                                               title="Editar">
                                                <i class="bi bi-pencil-square text-warning me-2"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            No hay capacitaciones asociadas.
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}


{% endblock %}

{% block scripts_detail %}
    <!-- Data table plugin-->
    <script src="{% static 'lib/vali-admin/js/plugins/jquery.dataTables.min.js' %}"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.13.4/datatables.min.css">

    <script>

        try {
            $(function () {
                // Solo inicializar DataTable si hay filas de datos
                const hasDataZero = $('#data_0 tbody tr').length > 0 && !$('#data_0 tbody tr td[colspan]').length;
                const hasDataOne = $('#data_1 tbody tr').length > 0 && !$('#data_1 tbody tr td[colspan]').length;

                if (hasDataZero) {
                    $('#data_0').DataTable({
                        responsive: true,
                        autoWidth: false,
                        searching: false,
                        info: false,
                        order: [[3, 'desc']],
                        language: {
                            url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                        },
                        columnDefs: [
                            {
                                targets: [1, 5],
                                className: 'align-middle text-center',
                                orderable: false,
                            },
                            {
                                targets: [0, 2, 3, 4],
                                className: 'align-middle text-center',
                            }
                        ]
                    });
                } else {
                    console.info('DataTable no inicializado: tabla vacía o sin datos válidos');
                }

                if (hasDataOne) {
                    $('#data_1').DataTable({
                        responsive: true,
                        autoWidth: false,
                        searching: false,
                        info: false,
                        order: [[0, 'desc']],
                        language: {
                            url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                        },
                        columnDefs: [
                            {
                                targets: [5],
                                className: 'align-middle text-center',
                                orderable: false,
                            },
                            {
                                targets: [0, 1, 2, 3, 4],
                                className: 'align-middle text-center',
                            }
                        ]
                    });
                } else {
                    console.info('DataTable no inicializado: tabla vacía o sin datos válidos');
                }
            })
        } catch (error) {
            console.error('Error al inicializar DataTable:', error);
        }

    </script>

{% endblock %}
