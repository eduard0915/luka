{% extends 'body.html' %}
{% load static %}


{% block head %}
    {% block head_list %}
        <style>
            /* Ajustes para la tabla con id data_0 */
            #data_0, #data_0 th, #data_0 td {
                font-size: 0.85rem;
            }

            #data_0 thead th {
                text-align: center;
                vertical-align: middle;
            }
        </style>
    {% endblock %}
{% endblock %}

{% block content %}

    <div class="tile mb-3" style="width: 83%">
        <div class="row">
            <div class="col-md-2 mt-4">
                <div class="avatar avatar-xl">
                    {% if object.photo %}
                        <img src="{{ object.photo.url }}" alt="perfil-lims" class="w-100 img-radius-10">
                    {% else %}
                        <img src="{% static 'img/default-avatar.png' %}" alt="perfil-lims" class="w-100 img-radius-10">
                    {% endif %}
                </div>
            </div>
            <div class="col-md-10">
                <div class="tile-title-w-btn m-3">
                    <h3 class="title">{{ object.get_full_name }}, {{ object.cargo }}</h3>
                </div>
                <div class="tile-body m-3">
                    <div class="row">
                        <div class="col-md-3">
                            <b>Cedula </b><br>
                            <p>{{ object.cedula }}</p>
                        </div>
                        <div class="col-md-3">
                            <b>Usuario </b><br>
                            <p>{{ object.username }}</p>
                        </div>
                        <div class="col-md-2">
                            <b>Cedula </b><br>
                            <p>{{ object.cedula }}</p>
                        </div>
                        <div class="col-md-2">
                            <b>Celular </b><br>
                            <p>
                                {% if object.cellphone %}
                                    {{ object.cellphone }}
                                {% else %}
                                    Pendiente
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-2">
                            {% if perms.user.add_user %}
                                <a href="{% url 'user:user_update_admin' object.slug %}"
                                   class="btn btn-warning icon-btn">
                                    <i class="bi bi-pencil-square me-2"></i>Editar
                                </a>
                            {% else %}
                                <a href="{% url 'user:user_update_user' object.slug %}"
                                   class="btn btn-warning icon-btn">
                                    <i class="bi bi-pencil-square me-2"></i>Editar</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <b>Email </b><br>
                            <p>{{ object.email }}</p>
                        </div>
                        <div class="col-md-3">
                            <b>Dirección</b><br>
                            <p>
                                {% if object.address_user %}
                                    {{ object.address_user }}
                                {% else %}
                                    Pendiente
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <b>Fecha de Nacimiento</b><br>
                            <p>
                                {% if object.date_birth %}
                                    {{ object.date_birth | date:'Y-m-d' }}
                                {% else %}
                                    Pendiente
                                {% endif %}
                            </p>
                        </div>
                        {% if perms.user.add_user %}
                            <div class="col-md-3">
                                <b>Ultima Sesión</b><br>
                                <p>
                                    {% if object.last_login %}
                                        {{ object.last_login | date:'Y-m-d' }}
                                    {% else %}
                                        Usuario sin inicio de sesión
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10">
            <div class="tile mb-3">
                <div class="tile-title-w-btn">
                    <h3 class="title">Capacitaciones</h3>
                    <p>
                        <a class="btn btn-primary icon-btn"
                           onclick="open_modal('{% url 'user:create_training' object.slug %}')"><i
                                class="bi bi-plus-square me-2"></i>Nuevo</a>

                    </p>
                </div>
                <div class="tile-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered" id="data_0">
                            <thead>
                            <tr>
                                <th style="width:35%">Descripción</th>
                                <th style="width:5%">Ver</th>
                                <th style="width:25%">Realizada por</th>
                                <th style="width:13%">Fecha</th>
                                <th style="width:10%">Estado</th>
                                <th style="width:12%">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for foo in training %}
                                <tr>
                                    <td>{{ foo.description_training }}</td>
                                    <td>
                                        <a href="{% url 'user:download_training' %}?id={{ foo.id }}&type=support_training"
                                           target="_blank">
                                            <i class="bi bi-file-earmark-pdf text-danger"></i>
                                        </a>
                                    </td>
                                    <td>{{ foo.training_by }}</td>
                                    <td>{{ foo.date_training | date:'Y-m-d' }}</td>
                                    <td>
                                        {% if foo.training_status == 'Vencido' %}
                                            <span class="badge bg-danger">{{ foo.training_status }}</span>
                                        {% else %}
                                            {{ foo.training_status }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a onclick="open_modal('{% url 'user:update_training' foo.id %}')"
                                           title="Editar">
                                            <i class="bi bi-pencil-square text-warning me-2"></i>
                                        </a>
                                        <a onclick="open_modal('{% url 'user:delete_training' foo.id %}')"
                                           title="Eliminar">
                                            <i class="bi bi-trash text-danger me-2"></i>
                                        </a>
                                        {% if foo.training_status == 'Vencido' %}
                                            <a onclick="open_modal('{% url 'user:create_update_training' foo.id %}')"
                                               title="Actualizar">
                                                <i class="bi bi-arrow-clockwise text-info me-2"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">
                                        No hay capacitaciones asociadas.
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="tile">
                <div class="tile-title-w-btn">
                    <h3 class="title">Competencias</h3>
                    <p>
                        <a class="btn btn-primary icon-btn"
                           onclick="open_modal('{% url 'user:create_competence' object.slug %}')"><i
                                class="bi bi-plus-square me-2"></i>Nuevo</a>

                    </p>
                </div>
                <div class="tile-body">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Ver</th>
                            <th>Institución</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for cp in competence %}
                            <tr>
                                <td>{{ cp.description_competence }}</td>
                                <td>
                                    <a href="{% url 'user:download_competence' %}?id={{ cp.id }}&type=support_competence"
                                       target="_blank">
                                        <i class="bi bi-file-earmark-pdf text-danger"></i>
                                    </a>
                                </td>
                                <td>{{ cp.institution }}</td>
                                <td>
                                    <a onclick="open_modal('{% url 'user:update_competence' cp.id %}')"
                                       title="Editar">
                                        <i class="bi bi-pencil-square text-warning me-2"></i>
                                    </a>
                                    <a onclick="open_modal('{% url 'user:delete_competence' cp.id %}')"
                                       title="Eliminar">
                                        <i class="bi bi-trash text-danger me-2"></i>
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">
                                    No hay competencias asociadas.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts_detail %}
    <!-- Data table plugin-->
    <script src="{% static 'lib/vali-admin/js/plugins/jquery.dataTables.min.js' %}"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.13.4/datatables.min.css">

    <script>

        try {
            $(function () {
                // Solo inicializar DataTable si hay filas de datos
                const hasData = $('#data_0 tbody tr').length > 0 && !$('#data_0 tbody tr td[colspan]').length;

                if (hasData) {
                    $('#data_0').DataTable({
                        responsive: true,
                        autoWidth: false,
                        searching: false,
                        info: false,
                        order: [[3, 'desc']],
                        language: {
                            url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                        },
                        columnDefs: [
                            {
                                targets: [1, 5],
                                className: 'td-actions text-center',
                                orderable: false,
                            },
                            {
                                targets: [2, 3, 4],
                                className: 'td-actions text-center',
                            }
                        ]
                    });
                } else {
                    console.info('DataTable no inicializado: tabla vacía o sin datos válidos');
                }
            })
        } catch (error) {
            console.error('Error al inicializar DataTable:', error);
        }

    </script>

{% endblock %}
