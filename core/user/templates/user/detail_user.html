{% extends 'body.html' %}
{% load static %}


{% block head %}
    {% block head_list %}
                <style>
                    /* Ajustes para la tabla con id data_0 */
                    #data_0, #data_0 th, #data_0 td {
                        font-size: 0.85rem;
                    }
                    #data_0 thead th {
                        text-align: center;
                        vertical-align: middle;
                    }
                    {##data_0 tbody td {#}
                    {#    text-align: center;#}
                    {#    vertical-align: middle;#}
                    {# }#}
                </style>
    {% endblock %}
{% endblock %}

{% block content %}

    <div class="tile mb-3" style="width: 83%">
        <div class="row">
            <div class="col-md-2">
                <div class="avatar avatar-xl">
                    <img src="{% static 'img/default-avatar.png' %}" alt="profile_image"
                         class="w-100 border-radius-lg shadow-sm">
                </div>
            </div>
            <div class="col-md-10">
                    <div class="tile-title-w-btn m-3">
                        <h3 class="title">{{ object.get_full_name }}, {{ object.cargo }}</h3>
                    </div>
                    <div class="tile-body m-3">
                        <div class="row">
                            <div class="col-md-3">
                                <b>Cedula </b><br>
                                <p>{{ object.cedula }}</p>
                            </div>
                            <div class="col-md-3">
                                <b>Usuario </b><br>
                                <p>{{ object.username }}</p>
                            </div>
                            <div class="col-md-2">
                                <b>Cedula </b><br>
                                <p>{{ object.cedula }}</p>
                            </div>
                            <div class="col-md-3">
                                <b>Celular </b><br>
                                <p>{{ object.cellphone }}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <b>Email </b><br>
                                <p>{{ object.email }}</p>
                            </div>
                            <div class="col-md-5">
                                <b>Dirección</b><br>
                                <p>{{ object.address_user }}</p>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10">
            <div class="tile mb-3">
                <div class="tile-title-w-btn">
                    <h3 class="title">Capacitaciones</h3>
                    <p>
                        <a class="btn btn-primary icon-btn"
                           onclick="open_modal('{% url 'user:create_training' object.slug %}')"><i
                                class="bi bi-plus-square me-2"></i>Nuevo</a>

                    </p>
                </div>
                <div class="tile-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered" id="data_0">
                            <thead>
                            <tr>
                                <th style="width:35%">Descripción</th>
                                <th style="width:5%">Ver</th>
                                <th style="width:30%">Realizada por</th>
                                <th style="width:13%">Fecha</th>
                                <th style="width:10%">Estado</th>
                                <th style="width:7%">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for foo in training %}
                                <tr>
                                    <td>{{ foo.description_training }}</td>
                                    <td>
                                        <a href="{% url 'user:download_training' %}?id={{ foo.id }}&type=support_training"
                                           target="_blank">
                                            <i class="bi bi-file-earmark-pdf text-danger"></i>
                                        </a>
                                    </td>
                                    <td>{{ foo.training_by }}</td>
                                    <td>{{ foo.date_training | date:'Y-m-d' }}</td>
                                    <td>{{ foo.training_status }}</td>
                                    <td>
                                        <a onclick="open_modal('{% url 'user:update_training' foo.id %}')"
                                           title="Editar">
                                            <i class="bi bi-pencil-square text-warning me-2"></i>
                                        </a>
                                        <a onclick="open_modal('{% url 'user:update_training' foo.id %}')"
                                           title="Eliminar">
                                            <i class="bi bi-trash text-danger me-2"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">
                                        No hay competencias asociadas.
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="tile">
                <div class="tile-title-w-btn">
                    <h3 class="title">Competencias</h3>
                    <p>
                        <a class="btn btn-primary icon-btn"
                           onclick="open_modal('{% url 'user:create_competence' object.slug %}')"><i
                                class="bi bi-plus-square me-2"></i>Nuevo</a>

                    </p>
                </div>
                <div class="tile-body">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Ver</th>
                            <th>Institución</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for cp in competence %}
                            <tr>
                                <td>{{ cp.description_competence }}</td>
                                <td>
                                    <a href="{% url 'user:download_competence' %}?id={{ cp.id }}&type=support_competence"
                                       target="_blank">
                                        <i class="bi bi-file-earmark-pdf text-danger"></i>
                                    </a>
                                </td>
                                <td>{{ cp.institution }}</td>
                                <td>
                                    <a onclick="open_modal('{% url 'user:update_competence' cp.id %}')"
                                       title="Editar">
                                        <i class="bi bi-pencil-square text-warning me-2"></i>
                                    </a>
                                    <a onclick="open_modal('{% url 'user:delete_competence' cp.id %}')"
                                       title="Eliminar">
                                        <i class="bi bi-trash text-danger me-2"></i>
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">
                                    No hay competencias asociadas.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts_detail %}
    <!-- Data table plugin-->
    <script src="{% static 'lib/vali-admin/js/plugins/jquery.dataTables.min.js' %}"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.13.4/datatables.min.css">

    <script>
        // Initialize tooltips
        {#document.addEventListener("DOMContentLoaded", function () {#}
        {#    // Inicializar tooltips#}
        {#    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));#}
        {#    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {#}
        {#        return new bootstrap.Tooltip(tooltipTriggerEl);#}
        {#    });#}
        {##}
        {#    // Inicializar DataTable con la variable global#}
        {#    try {#}
        {#        if (typeof DataTable === 'function') {#}
        {#            new DataTable('#data_0', {#}
        {#                responsive: true,#}
        {#                autoWidth: false,#}
        {#                info: false,#}
        {#                pageLength: 5,#}
        {#                scrollX: false,#}
        {#                lengthMenu: [5, 10, 25, 50, 75, 100],#}
        {#                order: [[3, 'desc']],#}
        {#                language: {#}
        {#                    "emptyTable": "No hay información",#}
        {#                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Registros",#}
        {#                    "infoEmpty": "Mostrando 0 to 0 of 0 Registros",#}
        {#                    "infoFiltered": "(Filtrado de _MAX_ total Registros)",#}
        {#                    "lengthMenu": "Mostrar _MENU_ Registros",#}
        {#                    "loadingRecords": "Cargando...",#}
        {#                    "processing": "Procesando...",#}
        {#                    "search": "Buscar:",#}
        {#                    "zeroRecords": "Sin resultados encontrados",#}
        {#                }#}
        {#            });#}
        {#        } else {#}
        {#            console.error('La función DataTable no está disponible');#}
        {#        }#}
        {#    } catch (error) {#}
        {#        console.error('Error al inicializar DataTable:', error);#}
        {#    }#}
        {# });#}
        $(function () {
            $('#data_0').DataTable({
                responsive: true,
                autoWidth: false,
                searching: false,
                orderable: ['3', 'desc'],
                info: false,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                },
                columnDefs: [
                    {
                        targets: [2, 3, 4],
                        className: 'td-actions text-center',
                    },
                    {
                        targets: [1, 5],
                        className: 'td-actions text-center',
                        orderable: false,
                    },
                ]
            });

            $('.btnTest').on('click', function () {
                $.ajax({
                    url: window.location.pathname,
                    type: 'POST',
                    data: {id: 1},
                    dataType: 'json'
                }).done(function (data) {
                    console.log(data);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    alert(textStatus + ': ' + errorThrown);
                }).always(function (data) {
                });
            });
        });

        // Handle form submission in modal using vanilla JavaScript
        document.addEventListener('submit', function (e) {
            // Check if the form is inside a modal
            if (e.target.closest('.modal') && e.target.tagName === 'FORM') {
                e.preventDefault();
                var form = e.target;
                var url = form.getAttribute('action');
                var data = new FormData(form);

                // Use fetch API instead of $.ajax
                fetch(url, {
                    method: 'POST',
                    body: data
                })
                    .then(response => response.json())
                    .then(response => {
                        if (!response.hasOwnProperty('error')) {
                            // Close modal using Bootstrap 5 syntax
                            var modalElement = document.getElementById('modal_template');
                            var modalInstance = bootstrap.Modal.getInstance(modalElement);
                            modalInstance.hide();
                            // Reload page to show new data
                            location.reload();
                        } else {
                            // Show error message
                            alert(response.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error en el envío del formulario');
                    });
            }
        });
    </script>

{% endblock %}
